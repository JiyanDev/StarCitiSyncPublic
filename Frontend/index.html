<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Game Session ‚Äì Statistics</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Vera+Mono&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
    }
    @font-face {
      font-family: 'Vera Mono';
      src: url('./fonts/VeraMono.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
    }
    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      margin: 0;
      padding: 0;
      background-color: #181818;
      color: #e0e0e0;
      font-family: 'Segoe UI', Roboto, sans-serif;
      overflow-x: hidden;
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }

    #timer {
      font-size: 2rem;
      color: #ffa94d;
      margin-bottom: 2rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1.5rem;
      width: 100%;
      max-width: 1000px;
      margin-bottom: 3rem;
    }

    .stat-card {
      background-color: #222222;
      padding: 1.2rem 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .stat-value#latest-mission {
      display: block;
      max-width: 100%;
      max-height: 3.6em;
      overflow: hidden;
      text-overflow: ellipsis;

      white-space: normal;
      word-break: break-word;
      line-height: 1.8em;
      cursor: help;
    }

    .stat-label {
      font-size: 0.9rem;
      color: #bbbbbb;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: bold;
      margin-top: 0.5rem;
      color: #ffb347;
    }

    canvas {
      max-width: 1000px;
      width: 100%;
      height: auto;
      background-color: #1f1f1f;
      border-radius: 12px;
      padding: 1rem;
      display: block;
    }

  .titlebar {
    width: 100vw;
    height: 36px;
    background-color: #142a3a;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 1rem;
    -webkit-app-region: drag;
    user-select: none;
    box-sizing: border-box;
    position: sticky;
    top: 0;
    z-index: 1000;
  }

  .quit-btn {
    position: absolute;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
    background: #ff4d4d;
    color: #fff;
    border: none;
    padding: 0.4rem 1.1rem;
    border-radius: 6px;
    font-size: 1rem;
    cursor: pointer;
    z-index: 10;
    transition: background 0.2s;
    -webkit-app-region: no-drag;
  }
  .quit-btn:hover {
    background: #590d0d;
  }

  .menu-button {
    position: absolute;
    left: 1rem;
    font-size: 20px;
    cursor: pointer;
    -webkit-app-region: no-drag;
    color: #ffb347;
    margin-left: 0;
  }

    .content {
      flex: 1 0 auto;
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      padding: 1rem 2rem;
      box-sizing: border-box;
    }

    h1.style1 {
      font-family: 'Vera Mono', monospace;
      font-size: 20px;
      margin: 0;  
      white-space: nowrap;
      color: #ffa94d;
      user-select: none;
      transform: translateY(2px); 
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    #spending-summary-card {
      padding: 0.8rem 1rem;
      font-size: 0.85rem;
      max-width: 500px;
      margin-top: 1rem;
    }
    #spending-summary-card h2 {
      font-size: 1.2rem;
      margin-bottom: 1rem;
    }
    #spending-summary-card .stat-label {
      font-size: 0.75rem;
    }
    #spending-summary-card .stat-value {
      font-size: 1rem;
      text-align: right;
    }
    #spending-summary-card .stat-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .stat-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
  }
  .stat-label {
    font-size: 0.75rem;
  }
  .stat-value {
    font-size: 1rem;
    text-align: right;
  }
  footer {
    margin-top: auto;
  }
  </style>
</head>
<body>
  <div class="titlebar">
    <div class="menu-button">‚ò∞</div>
    <h1 class="style1">StarCitiSync</h1>
    <div id="version-label" style="margin-right:1.2rem;color:#bbb;font-size:1rem;position:absolute;right:3.5rem;top:50%;transform:translateY(-50%);">
      <a id="version-link"
        href="https://github.com/JiyanDev/StarCitiSyncPublic/releases/latest"
        target="_blank"
        style="
          display: inline-block;
          padding: 0.3rem 1.1rem;
          border-radius: 6px;
          color: inherit;
          text-decoration: none;
          cursor: pointer;
          -webkit-app-region: no-drag;
          background: rgba(0,0,0,0); /* osynlig bakgrund */
          transition: background 0.15s;
        "
        onmouseover="this.style.background='rgba(255,255,255,0.07)'"
        onmouseout="this.style.background='rgba(0,0,0,0)'"
      ></a>
    </div>
    <div id="update-btn" style="display:none;position:absolute;right:7.5rem;top:50%;transform:translateY(-50%);background:#4caf50;color:#fff;border:none;padding:0.4rem 1.1rem;border-radius:6px;font-size:1rem;cursor:pointer;z-index:10;transition:background 0.2s;-webkit-app-region:no-drag;">
      Update
    </div>
  <button id="quit-btn" class="quit-btn">x</button>

  </div>
  <div class="content">

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Session Time</div>
        <div class="stat-value" id="timer">00:00:00</div>
      </div>

      <div class="stat-card">
        <div class="stat-label">Missions Completed</div>
        <div class="stat-value" id="mission-count">0</div>

        <div class="stat-label" style="margin-top:1rem;">Kills</div>
        <div class="stat-value" id="kill-count">0</div>
      </div>

      <div class="stat-card">
        <div class="stat-label">Latest Mission</div>
        <div class="stat-value" id="latest-mission">None Active</div>
      </div>

      <div class="stat-card">
        <div class="stat-label">Total Reward</div>
        <div class="stat-value" id="total-reward">0 UEC</div>
      </div>

      <div class="stat-card">
        <div class="stat-label">Reward Last Hour</div>
        <div class="stat-value" id="reward-last-hour">0 UEC</div>
      </div>

      <div class="stat-card">
        <div class="stat-label">Average per Hour</div>
        <div class="stat-value" id="reward-per-hour">0 UEC/h</div>
      </div>
    </div>
    <canvas id="rewardChart" height="100"></canvas>
    <div style="display: flex; gap: 1.5rem; justify-content: flex-start; align-items: flex-start; flex-wrap: wrap; margin-bottom: 2rem;">      
      <div class="stat-card" id="spending-summary-card" style="padding: 0.8rem 1rem; font-size: 0.85rem; max-width: 500px; margin-top: 1rem;">
        <h2 style="font-size: 1.2rem; margin-bottom: 1rem;">üí∏ Spending Summary</h2>

        <div class="stat-row">
          <div class="stat-label" style="font-size: 0.75rem;">Total Spent:</div>
          <div class="stat-value" id="total-spent" style="text-align:right; font-size: 1rem;">0 aUEC</div>
        </div>
        <div class="stat-row">
          <div class="stat-label" style="font-size: 0.75rem;">üè™ Top Shop:</div>
          <div class="stat-value" id="top-shop" style="text-align:right; font-size: 1rem;">‚Äì</div>
        </div>
        <!-- <div class="stat-row">
          <div class="stat-label" style="font-size: 0.75rem;">üì¶ Object:</div>
          <div class="stat-value" id="top-item" style="text-align:right; font-size: 1rem;">‚Äì</div>
        </div> -->
        <div class="stat-row">
          <div class="stat-label" style="font-size: 0.75rem;">üîÑ Transactions:</div>
          <div class="stat-value" id="transaction-count" style="text-align:right; font-size: 1rem;">0</div>
        </div>
        <div class="stat-row">
          <div class="stat-label" style="font-size: 0.75rem;">üí∞ Most Purchased Item (All Sessions):</div>
          <div class="stat-value" id="top-global-item" style="text-align:right; font-size: 1rem;">‚Äì</div>
        </div>
      </div>
      <div class="stat-card" id="commodity-summary-card" style="padding: 0.8rem 1rem; font-size: 0.85rem; max-width: 500px; margin-top: 1rem;">
        <h2 style="font-size: 1.2rem; margin-bottom: 1rem;">üì¶ Commodity Profit</h2>
        <div class="stat-row">
          <div class="stat-label" style="font-size: 0.75rem;">Profit:</div>
          <div class="stat-value" id="commodity-profit" style="text-align:right; font-size: 1rem;">0 aUEC</div>
        </div>
        <div class="stat-row">
          <div class="stat-label" style="font-size: 0.75rem;">ROI:</div>
          <div class="stat-value" id="commodity-roi" style="text-align:right; font-size: 1rem;">0%</div>
        </div>
        <div class="stat-row">
          <div class="stat-label" style="font-size: 0.75rem;">Total Bought:</div>
          <div class="stat-value" id="commodity-total-buy" style="text-align:right; font-size: 1rem;">0 aUEC</div>
        </div>
        <div class="stat-row">
          <div class="stat-label" style="font-size: 0.75rem;">Total Sold:</div>
          <div class="stat-value" id="commodity-total-sell" style="text-align:right; font-size: 1rem;">0 aUEC</div>
        </div>
      </div>
    </div>
  </div>
  <footer style="
    width: 100vw;
    background: rgba(20, 42, 58, 0); /* N√§stan osynlig bakgrund */
    color: #bbb;
    font-size: 1rem;
    text-align: center;
    padding: 0.3rem 0 0.3rem 0;
    letter-spacing: 0.5px;
    opacity: 0.98;
    user-select: none;
    border-top: 1px solid rgba(20, 42, 58, 0.039);
    margin-top: auto;
  ">
    <span>¬© 2025 <a href="https://github.com/JiyanDev" target="_blank" style="color:#c9c9c9;text-decoration:none;font-weight:bold;-webkit-app-region:no-drag;">JiyanDev</a></span>
  </footer>
  <script>
    window.electronAPI.getAppVersion().then(version => {
      document.getElementById('version-link').innerText = `v${version}`;
    });
    document.getElementById('quit-btn').addEventListener('click', () => {
      electronAPI.quitApp();
    });

    document.querySelector('.menu-button').addEventListener('click', () => {
      //alert('Menu button clicked!');
      // side panel toggle or open menu logic here
    });

    function resizeCanvasToDisplaySize(canvas) {
      const dpr = window.devicePixelRatio || 1;
      const width = canvas.clientWidth * dpr;
      const height = (canvas.clientWidth / 3) * dpr;

      if (canvas.width !== width || canvas.height !== height) {
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        return true;
      }
      return false;
    }

    const canvas = document.getElementById('rewardChart');
    resizeCanvasToDisplaySize(canvas);

    const ctx = document.getElementById('rewardChart').getContext('2d');
    const rewardChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Reward Over Time',
          data: [],
          borderColor: '#ffb347',
          backgroundColor: 'rgba(255, 179, 71, 0.1)',
          borderWidth: 2,
          tension: 0.25,
          fill: true,
          pointRadius: 3
        }]
      },
      options: {
        scales: {
          x: {
            ticks: { color: '#ccc' },
            grid: { color: '#333' }
          },
          y: {
            beginAtZero: true,
            ticks: { color: '#ccc' },
            grid: { color: '#333' }
          }
        },
        plugins: {
          legend: { labels: { color: '#ccc' } }
        }
      }
    });

    session.onTimeUpdate(timeStr => {
      document.getElementById('timer').innerText = timeStr;
    });

    session.onMissionCountUpdate(count => {
      document.getElementById('mission-count').innerText = count;
    });

    session.onLatestMission(mission => {
      const text = mission
        ? `${mission.Contract} (${mission.CompletionType || 'In Progress'})`
        : 'None Active';
      const el = document.getElementById('latest-mission');
      el.innerText = text;
      el.title = text;
    });

    session.onRewardUpdate(total => {
      document.getElementById('total-reward').innerText = `${total.toLocaleString()} UEC`;
    });

    session.onRewardLastHour(value => {
      document.getElementById('reward-last-hour').innerText = `${value.toLocaleString()} UEC`;
    });

    session.onRewardPerHour(value => {
      document.getElementById('reward-per-hour').innerText = `${Math.round(value).toLocaleString()} UEC/h`;
    });

    session.onShopSummary(spendings => {
      //document.getElementById('shop-summary').innerText = JSON.stringify(spendings, null, 2);
      //console.log('üí∞ Summary:', spendings);
      document.getElementById('total-spent').innerText =
      (spendings.TotalSpent != null
        ? spendings.TotalSpent.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })
        : '0.00') + ' aUEC';
      document.getElementById('transaction-count').innerText = spendings.TotalTransactions ?? '0';
      //document.getElementById('top-item').innerText = spendings.TopItem ?? '‚Äì';
      document.getElementById('top-shop').innerText = spendings.TopShop ?? '‚Äì';
      document.getElementById('top-global-item').innerText = spendings.TopItem ?? '‚Äì';
    });

    function updateRewardGraph() {
      window.session.getRewardGraph().then(dataPoints => {
        rewardChart.data.labels = dataPoints.map(dp => dp.label);
        rewardChart.data.datasets[0].data = dataPoints.map(dp => dp.reward);
        rewardChart.update();
      });
    }

    function updateCommoditySummary() {
      window.session.getCommodityProfitAndROI().then(({ profit, roi, totalBuy, totalSell }) => {
        document.getElementById('commodity-profit').innerText =
          (profit != null ? profit.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0.00') + ' aUEC';
        document.getElementById('commodity-roi').innerText =
          (roi != null ? roi.toFixed(1) : '0.0') + '%';
        document.getElementById('commodity-total-buy').innerText =
          (totalBuy != null ? totalBuy.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0.00') + ' aUEC';
        document.getElementById('commodity-total-sell').innerText =
          (totalSell != null ? totalSell.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0.00') + ' aUEC';
      });
    }
    updateCommoditySummary();
    setInterval(updateCommoditySummary, 10000);

    function trackPlausible(eventName, props = {}) {
      fetch('https://plausible.io/api/event', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name: eventName,
          url: 'app://starcitisync',
          domain: 'starcitisyncpublic',
          props
        })
      });
    }
    trackPlausible('app_open');

    window.addEventListener('resize', () => {
      const resized = resizeCanvasToDisplaySize(canvas);
      if (resized) {
        rewardChart.resize();
      }
      updateRewardGraph();
    });

    updateRewardGraph();

    setInterval(updateRewardGraph, 60_000);
  </script>
</body>
</html>
